---
title: 狗东商城(二)
date: 2019-09-16 14:47:42
categories: [flutter]
tags: [项目,狗东商城]
---

# 页面布局

## 	页面布局的管理

``` dart
import 'package:flutter/material.dart';
void main() => runApp(MyApp());

class MyApp extends StatefulWidget {
  MyApp({Key key}) : super(key: key);
  _MyAppState createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {
  @override
  Widget build(BuildContext context) {
    return MultiProvider(providers: [
      ChangeNotifierProvider(builder: (_) => Counter()),
      ChangeNotifierProvider(builder: (_) => Cart())
    ],
      child: MaterialApp( // 此处对应之前的路由配置
        initialRoute: '/',
        onGenerateRoute:onGenerateRoute,
        theme: ThemeData(
            primaryColor: Colors.white
        ),
      ),
    );
  }
}
```

## home页面

``` dart
import 'package:flutter/material.dart';
import 'package:flutter_swiper/flutter_swiper.dart';
import '../../service/ScreenAdaper.dart';
import '../../model/FocusModel.dart';
import '../../model/ProductModel.dart';
import 'package:dio/dio.dart';
import '../../config/Config.dart';

class HomePage extends StatefulWidget {
  HomePage({Key key}) : super(key: key);

  _HomePageState createState() => _HomePageState();
}

class _HomePageState extends State<HomePage>
    with AutomaticKeepAliveClientMixin {
  @override
  bool get wantKeepAlive => true;
  List _focusData = [];
  List _faverData = [];
  List _hotData = [];

  @override
  void initState() {
    super.initState();
    _getFocusData();
    _getFaverDate();
    _getHotData();
  }

  // 获取轮播图数据
  _getFocusData() async {
    var api = '${Config.domain}api/focus';
    print("api:" + "${api}");
    var result = await Dio().get(api);
    print(result);
    var focusList = FocusModel.fromJson(result.data);
    print("modeldate:${focusList.result}");
    setState(() {
      this._focusData = focusList.result;
    });
  }

  // 获取猜你喜欢的商品的数据
  _getFaverDate() async {
    var api = '${Config.domain}api/plist?is_hot=1';
    print("faver:" + "${api}");
    var result = await Dio().get(api);
    var faverList = ProductModel.fromJson(result.data);
    setState(() {
      this._faverData = faverList.result;
    });
  }

  // 获得热门推荐数据
  _getHotData() async {
    var api = '${Config.domain}api/plist?is_best=1';
    var result = await Dio().get(api);
    var hotList = ProductModel.fromJson(result.data);
    setState(() {
      this._hotData = hotList.result;
    });
  }

  //轮播图
  Widget _swiperWidget() {
    return Container(
      child: AspectRatio(
        aspectRatio: 2 / 1,
        child: Swiper(
            itemBuilder: (BuildContext context, int index) {
              String pic = this._focusData[index].pic;
              pic = Config.domain + pic.replaceAll('\\', '/');
              return new Image.network(
                "${pic}",
                fit: BoxFit.fill,
              );
            },
            itemCount: this._focusData.length,
            pagination: new SwiperPagination(), // index标志
            autoplay: true),
      ),
    );
  }

  Widget _titleWidget(value) {
    return Container(
      height: ScreenAdaper.height(38),
      margin: EdgeInsets.only(left: ScreenAdaper.width(10)),
      padding: EdgeInsets.only(left: ScreenAdaper.width(10)),
      decoration: BoxDecoration(
          border: Border(
              left: BorderSide(
        color: Colors.red,
        width: ScreenAdaper.width(10),
      ))),
      child: Text(
        value,
        style: TextStyle(color: Colors.black54),
      ),
    );
  }

  // 猜你喜欢
  Widget _hotProductListWidget() {
    if (_faverData.length > 0) {
      return Container(
        height: ScreenAdaper.height(234),
        padding: EdgeInsets.all(ScreenAdaper.width(20)),
        child: ListView.builder(
          scrollDirection: Axis.horizontal,
          itemBuilder: (contxt, index) {
            var pic = this._faverData[index].sPic;
            pic = Config.domain + pic.replaceAll('\\', '/');
            return Column(
              children: <Widget>[
                Container(
                  height: ScreenAdaper.height(140),
                  width: ScreenAdaper.width(140),
                  margin: EdgeInsets.only(right: ScreenAdaper.width(21)),
                  // padding: EdgeInsets.only(right: ScreenAdaper.width(21)),
                  child: Image.network(pic, fit: BoxFit.cover),
                ),
                Container(
                  padding: EdgeInsets.only(top: ScreenAdaper.height(10)),
                  height: ScreenAdaper.height(44),
                  child: Text("￥${this._faverData[index].price}"),
                )
              ],
            );
          },
          itemCount: _faverData.length,
        ),
      );
    } else {
      return Text("");
    }
  }

  _recProductItemWidgetfix() {
    var itemWidth = (ScreenAdaper.getScreenWidth() - 30) / 2;
    return Container(
      padding: EdgeInsets.all(10),
      child: Wrap(
          runSpacing: 10,
          spacing: 10,
          children: this._hotData.map((value) {
            var pic = value.sPic;
            pic = Config.domain + pic.replaceAll('\\', '/');
            return Container(
                padding: EdgeInsets.all(10),
                width: itemWidth,
                decoration: BoxDecoration(
                    border: Border.all(
                        color: Color.fromRGBO(233, 233, 233, 0.9), width: 1)),
                child: InkWell(
                  onTap: () {
                    Navigator.pushNamed(context, '/productContent',
                        arguments: {"id": value.sId});
                  },
                  child: Column(
                    children: <Widget>[
                      Container(
                        width: double.infinity,
                        child: AspectRatio(
                          //防止服务器返回的图片大小不一致导致高度不一致问题
                          aspectRatio: 1 / 1,
                          child: Image.network(
                            '${pic}',
                            fit: BoxFit.cover,
                          ),
                        ),
                      ),
                      Padding(
                        padding: EdgeInsets.only(top: ScreenAdaper.height(20)),
                        child: Text(
                          "${value.title}",
                          maxLines: 2,
                          overflow: TextOverflow.ellipsis,
                          style: TextStyle(color: Colors.black54),
                        ),
                      ),
                      Padding(
                        padding: EdgeInsets.only(top: ScreenAdaper.height(20)),
                        child: Stack(
                          children: <Widget>[
                            Align(
                              alignment: Alignment.centerLeft,
                              child: Text(
                                "${value.price}",
                                style:
                                    TextStyle(color: Colors.red, fontSize: 16),
                              ),
                            ),
                            Align(
                              alignment: Alignment.centerRight,
                              child: Text("${value.oldPrice}",
                                  style: TextStyle(
                                      color: Colors.black54,
                                      fontSize: 14,
                                      decoration: TextDecoration.lineThrough)),
                            )
                          ],
                        ),
                      )
                    ],
                  ),
                ));
          }).toList()),
    );
  }

  @override
  Widget build(BuildContext context) {
    ScreenAdaper.init(context);
    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
            icon:
                Icon(Icons.center_focus_weak, size: 28, color: Colors.black87),
            onPressed: null),
        title: InkWell(
            onTap: () {
              Navigator.pushNamed(context, '/search');
            },
            child: Container(
              padding: EdgeInsets.only(left: 10),
              height: ScreenAdaper.height(68),
              decoration: BoxDecoration(
                  color: Color.fromRGBO(233, 233, 233, 0.8),
                  borderRadius: BorderRadius.circular(30)),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: <Widget>[
                  Icon(Icons.search),
                  Text("笔记本", style: TextStyle(fontSize: ScreenAdaper.size(28)))
                ],
              ),
            )),
        actions: <Widget>[
          IconButton(
              icon: Icon(
                Icons.message,
                size: 28,
                color: Colors.black87,
              ),
              onPressed: null)
        ],
      ),
      body: Center(
          child: ListView(
        children: <Widget>[
          _swiperWidget(),
          SizedBox(height: ScreenAdaper.width(20)),
          _titleWidget("猜你喜欢"),
          SizedBox(height: ScreenAdaper.width(20)),
          _hotProductListWidget(),
          _titleWidget("热门推荐"),
          _recProductItemWidgetfix(),
        ],
      )),
    );
  }
}

```

## Category页面

``` dart
import 'package:flutter/material.dart';
import '../../service/ScreenAdaper.dart';
import 'package:dio/dio.dart';
import '../../config/Config.dart';
import '../../model/CateModel.dart';

class CategoryPage extends StatefulWidget {
  CategoryPage({Key key}) : super(key: key);

  _CategoryPageState createState() => _CategoryPageState();
}

class _CategoryPageState extends State<CategoryPage>
    with AutomaticKeepAliveClientMixin {
  @override
  bool get wantKeepAlive => true;
  int _selectIndex = 0;
  List _leftdata = [];
  List _rightdata = [];

  @override
  void initState() {
    super.initState();
    _getLeftdata();
  }

  // 左边的数据请求
  _getLeftdata() async {
    var api = '${Config.domain}api/pcate';
    print("left:" + "${api}");
    var result = await Dio().get(api);
    print("result:+${result}");
    var leftList = Catemodel.fromJson(result.data);
    print("sult:+${leftList}");
    setState(() {
      this._leftdata = leftList.result;
    });
    _getRightCateData(this._leftdata[0].sId);
  }

  //右侧分类
  _getRightCateData(pid) async {
    var api = '${Config.domain}api/pcate?pid=${pid}';
    var result = await Dio().get(api);
    var rightCateList = new Catemodel.fromJson(result.data);
    // print(rightCateList.result);
    setState(() {
      this._rightdata = rightCateList.result;
    });
  }

  // 左边
  _leftWidget(leftWidth) {
    if (this._leftdata.length > 0) {
      return Container(
        width: leftWidth,
        height: double.infinity,
        // color: Colors.cyan,
        child: ListView.builder(
            itemCount: this._leftdata.length,
            itemBuilder: (context, index) {
              return Column(
                children: <Widget>[
                  InkWell(
                    onTap: () {
                      setState(() {
                        _selectIndex = index;
                        this._getRightCateData(this._leftdata[index].sId);
                      });
                    },
                    child: Container(
                      alignment: Alignment.center,
                      width: double.infinity,
                      //padding:EdgeInsets.only(top:ScreenAdaper.height(24)),
                      height: ScreenAdaper.height(84),
                      child: Text(
                        "${this._leftdata[index].title}",
                        textAlign: TextAlign.center,
                      ),
                      color: _selectIndex == index
                          ? Color.fromRGBO(240, 246, 246, 0.9)
                          : Colors.white,
                    ),
                  ),
                  Divider(height: 2),
                ],
              );
            }),
      );
    } else {
      return Container(
        width: leftWidth,
        height: double.infinity,
      );
    }
  }

  // 右边
  _rightWidget(rightItemWidth, rightItemHeight) {
    if (this._rightdata.length > 0) {
      return Expanded(
          flex: 1,
          child: Container(
              padding: EdgeInsets.all(ScreenAdaper.width(10)),
              height: double.infinity,
              color: Color.fromRGBO(240, 246, 246, 0.9),
              child: GridView.builder(
                  gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                      crossAxisCount: 3,
                      childAspectRatio: rightItemWidth / rightItemHeight,
                      crossAxisSpacing: 5, // 左右的间距
                      mainAxisSpacing: 2 // 上下的间距
                      ),
                  itemCount: this._rightdata.length,
                  itemBuilder: (context, index) {
                    //处理图片
                    String pic = this._rightdata[index].pic;
                    pic = Config.domain + pic.replaceAll('\\', '/');
                    return Container(
                        child: InkWell(
                      onTap: () => Navigator.pushNamed(context, '/productlist',
                          arguments: {
                            "cid": this._rightdata[index].sId,
                            "title": this._rightdata[index].title
                          }),
                      child: Column(
                        children: <Widget>[
                          AspectRatio(
                            aspectRatio: 1 / 1,
                            child: Image.network("${pic}", fit: BoxFit.cover),
                          ),
                          Container(
                            margin: EdgeInsets.only(top: 5),
                            height: ScreenAdaper.height(30),
                            child: Text(
                              "${this._rightdata[index].title}",
                              style: TextStyle(fontSize: 12),
                            ),
                          )
                        ],
                      ),
                    ));
                  })));
    } else {
      return Expanded(
          flex: 1,
          child: Container(
            padding: EdgeInsets.all(10),
            height: double.infinity,
            color: Color.fromRGBO(240, 246, 246, 0.9),
            child: Text("加载中..."),
          ));
    }
  }

  @override
  Widget build(BuildContext context) {
    ScreenAdaper.init(context);
    var leftWidth = ScreenAdaper.getScreenWidth() / 4;
    //右侧每一项宽度=（总宽度-左侧宽度-GridView外侧元素左右的Padding值-GridView中间的间距）/3
    var rightItemWidth =
        (ScreenAdaper.getScreenWidth() - leftWidth - 20 - 20) / 3;
    //获取计算后的宽度
    rightItemWidth = ScreenAdaper.width(rightItemWidth);
    //获取计算后的高度
    var rightItemHeight = rightItemWidth + ScreenAdaper.height(28);
    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
            icon:
                Icon(Icons.center_focus_weak, size: 28, color: Colors.black87),
            onPressed: null),
        title: InkWell(
            onTap: () {
              Navigator.pushNamed(context, '/search');
            },
            child: Container(
              padding: EdgeInsets.only(left: 10),
              height: ScreenAdaper.height(68),
              decoration: BoxDecoration(
                  color: Color.fromRGBO(233, 233, 233, 0.8),
                  borderRadius: BorderRadius.circular(30)),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: <Widget>[
                  Icon(Icons.search),
                  Text("笔记本", style: TextStyle(fontSize: ScreenAdaper.size(28)))
                ],
              ),
            )),
        actions: <Widget>[
          IconButton(
              icon: Icon(
                Icons.message,
                size: 28,
                color: Colors.black87,
              ),
              onPressed: null)
        ],
      ),
      body: new Row(
        children: <Widget>[
          _leftWidget(leftWidth),
          _rightWidget(rightItemWidth, rightItemHeight)
        ],
      ),
    );
  }
}

```

Cart页面

``` dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:gou_dong_store/provider/CheckOut.dart';
import '../../provider/Cart.dart';
import '../../service/ScreenAdaper.dart';
import '../../service/CartServices.dart';
import '../../service/UserServices.dart';
import 'package:fluttertoast/fluttertoast.dart';
import '../Cart/CartItem.dart';
import 'dart:convert';

class CartPage extends StatefulWidget {
  CartPage({Key key}) : super(key: key);

  _CartPageState createState() => _CartPageState();
}

class _CartPageState extends State<CartPage> {
  bool _isEdit = false;
  var checkOutProvider;

  @override
  void initState() {
    // TODO: implement initState
    super.initState();
    print("cart");
  }

  doCheckOut() async {
    //1、获取购物车选中的数据
    List checkOutData = await CartServices.getCheckOutData();
    print("----------------------------------${checkOutData}");
    //2、保存购物车选中的数据
    //this.checkOutProvider.changeCheckOutListData(checkOutData);
    //3、购物车有没有选中的数据
    if (checkOutData.length > 0) {
      //4、判断用户有没有登录
      var loginState = await UserServices.getUserLoginState();
      if (loginState) {
        Navigator.pushNamed(context, '/Text', arguments: {"flag": 1234});
        // Navigator.pushNamed(context, '/Text');

      } else {
        Fluttertoast.showToast(
          msg: '您还没有登录，请登录以后再去结算',
          toastLength: Toast.LENGTH_SHORT,
          gravity: ToastGravity.CENTER,
        );
        Navigator.pushNamed(context, '/login');
      }
    } else {
      Fluttertoast.showToast(
        msg: '购物车没有选中的数据',
        toastLength: Toast.LENGTH_SHORT,
        gravity: ToastGravity.CENTER,
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    //var counterProvider = Provider.of<Counter>(context);
    var cartProvider = Provider.of<Cart>(context);
    //checkOutProvider = Provider.of<CheckOut>(context);
    return Scaffold(
      appBar: AppBar(
        title: Text("购物车"),
        actions: <Widget>[
          IconButton(
            icon: Icon(Icons.launch),
            onPressed: () {
              setState(() {
                this._isEdit = !this._isEdit;
                cartProvider.notCheckAll();
              });
            },
          )
        ],
      ),
      body: cartProvider.cartList.length > 0
          ? Stack(
              children: <Widget>[
                ListView(
                  children: <Widget>[
                    Column(
                        children: cartProvider.cartList.map((value) {
                      return CartItem(value);
                    }).toList()),
                    SizedBox(height: ScreenAdaper.height(100))
                  ],
                ),
                Positioned(
                  bottom: 0,
                  width: ScreenAdaper.width(750),
                  height: ScreenAdaper.height(90),
                  child: Container(
                    padding: EdgeInsets.all(5),
                    decoration: BoxDecoration(
                      border: Border(
                          top: BorderSide(width: 1, color: Colors.black12)),
                      color: Colors.white,
                    ),
                    width: ScreenAdaper.width(750),
                    height: ScreenAdaper.height(90),
                    child: Stack(
                      children: <Widget>[
                        Align(
                          alignment: Alignment.centerLeft,
                          child: Row(
                            children: <Widget>[
                              Container(
                                width: ScreenAdaper.width(60),
                                child: Checkbox(
                                  value: cartProvider.isCheckedAll,
                                  activeColor: Colors.pink,
                                  onChanged: (val) {
                                    //实现全选或者反选
                                    cartProvider.checkAll(val);
                                  },
                                ),
                              ),
                              Text("全选"),
                              SizedBox(width: 20),
                              this._isEdit == false ? Text("合计:") : Text(""),
                              Container(
                                padding: EdgeInsets.only(left: 5),
                                child: this._isEdit == false
                                  ? Text("${cartProvider.allPrice}",
                                         style: TextStyle(
                                             fontSize: 20, color: Colors.red))
                                  : Text(""),
                              )
                            ],
                          ),
                        ),
                        this._isEdit == false
                          ? Align(
                              alignment: Alignment.centerRight,
                              child: Container(
                                  padding: EdgeInsets.only(right: 2),
                                  child: RaisedButton(
                                      child: Text("结算",
                                                  style: TextStyle(color: Colors.white)),
                                      color: Colors.red,
                                      onPressed: doCheckOut,
                                  ),
                              ))
                          : Align(
                              alignment: Alignment.centerRight,
                              child: RaisedButton(
                                  child: Text("删除",
                                              style: TextStyle(color: Colors.white)),
                                  color: Colors.red,
                                  onPressed: () {
                                      cartProvider.removeItem();
                                  },
                              ),
                          )
                      ],
                    ),
                  ),
                )
              ],
            )
        : Center(
            child: Text("购物车空空如也"),
        ),
    );
  }
}

```

User页面

``` dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../provider/Counter.dart';
import '../../service/ScreenAdaper.dart';
import '../../service/UserServices.dart';
import '../../widget/JdButton.dart';
import '../../service/EventBus.dart';
class UserPage extends StatefulWidget {
  UserPage({Key key}) : super(key: key);

  _UserPageState createState() => _UserPageState();
}

class _UserPageState extends State<UserPage> {

  bool isLogin=false; // 登陆状态
  List userInfo=[]; // 用户信息

  @override
  void initState() {
    // TODO: implement initState
    super.initState();
    this._getUserinfo();
    //监听登录页面改变的事件 (这是一个监听器，打开监听而已)，弹出登陆页面与页面销毁后，不会重新执行init的
    eventBus.on<UserEvent>().listen((event) {
      print(event.str);
      this._getUserinfo();
    });
  }

  @override
  void dispose() {
    super.dispose();
  }

  _getUserinfo() async{
    var isLogin=await UserServices.getUserLoginState();
    var userInfo=await UserServices.getUserInfo();
    setState(() {
      this.userInfo=userInfo;
      this.isLogin=isLogin;
    });

  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: ListView(
          children: <Widget>[
            Container(
              height: ScreenAdaper.width(220),
              width: double.infinity,
              decoration: BoxDecoration(
              image: DecorationImage(
                  image: AssetImage('images/user_bg.jpg'), fit: BoxFit.cover)),
              child: Row(
                children: <Widget>[
                  Container(
                    margin: EdgeInsets.fromLTRB(10, 0, 10, 0),
                    child: ClipOval(
                      child: Image.asset(
                        'images/user.png',
                        fit: BoxFit.cover,
                        width: ScreenAdaper.width(100),
                        height: ScreenAdaper.width(100),
                      ),
                    ),
                  ),
                  !this.isLogin?
                  Expanded(
                    flex: 1,
                    child: InkWell(
                      onTap: () {
                        Navigator.pushNamed(context, '/login');
                      },
                      child: Text("登录/注册", style: TextStyle(color: Colors.white)),
                    ),
                  ):
                  Expanded(
                      flex: 1,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: <Widget>[
                        Text("用户名：${this.userInfo[0]["username"]}",
                            style: TextStyle(
                                color: Colors.white,
                                fontSize: ScreenAdaper.size(32))),
                        Text("普通会员",
                            style: TextStyle(
                                color: Colors.white,
                                fontSize: ScreenAdaper.size(24))),
                      ],
                    ),)
                ],
              ),
            ),
            ListTile(
              leading: Icon(Icons.assignment, color: Colors.red),
              title: Text("全部订单"),
            ),
            Divider(),
            ListTile(
              leading: Icon(Icons.payment, color: Colors.green),
              title: Text("待付款"),
            ),
            Divider(),
            ListTile(
              leading: Icon(Icons.local_car_wash, color: Colors.orange),
              title: Text("待收货"),
            ),
            Container(  // 中间的分割线
                width: double.infinity,
                height: 10,
                color: Color.fromRGBO(242, 242, 242, 0.9)),
            ListTile(
              leading: Icon(Icons.favorite, color: Colors.lightGreen),
              title: Text("我的收藏"),
            ),
            Divider(),
            ListTile(
              leading: Icon(Icons.people, color: Colors.black54),
              title: Text("在线客服"),
            ),
            Divider(),
            JdButton(
              text: "退出登录",
              cb: (){
                UserServices.loginOut();
                this._getUserinfo();
              },
            )
          ],
        ),

      ),
    );
  }
}
```

