---
title: 搭建网关集群
date: 2019-05-27 17:03:35
categories: springcloud
tags: [集群,网关]
---

#  准备工作

​	打开 C:\Windows\System32\drivers\etc 下的hosts文件，在文件末尾加上

<!--more-->

``` yaml
# 后面的地址自定，随意
127.0.0.1 solo.ning.com  
```

找到你的 nginx 的配置文件，微微的更改一下，

``` yaml
#### 上游服务器 集群 默认轮训机制，需要自己加上
	upstream backServer{
		server 127.0.0.1:81 weight=10;
		server 127.0.0.1:82 weight=10;
	}
### 配置文件中存在，需要微微的更改一下
    server {
        listen       80;
        server_name  solo.ning.com;
        location / {
            ### 指定上游服务器负载均衡服务器
			proxy_pass http://backServer/;
			index index.html index.htm;
        }
```

# 开启zuul的网关

​	不辞劳苦的再来一遍吧，方便观看，来回的几个文件翻着总是不太方便

配置文件

``` yaml

###服务注册地址
eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8100/eureka/
###api网关端口号      
server:
  port: 82
###网关名称  
spring:
  application:
    name: service-zuul
  cloud:
    config:
    ####读取后缀
      profile: dev
      ####读取config-server注册地址
      discovery:
        service-id: config-server
        enabled: true    
zuul:
  routes:
    ###定义转发服务规则
    api-a:
      ### 当客户端发送请求 127.0.0.1:80/api-member开头的 都会转发到会员服务
      path: /api-member/**
      ###服务别名  zuul网关默认整合ribbon 自动实现负载均衡轮训效果
      serviceId: app-itmayiedu-member
    api-b:
      ### 当客户端发送请求 127.0.0.1:80/api-order开头的 都会转发到订单服务
      path: /api-order/**
      ##订单服务别名
      serviceId: app-itmayiedu-order
    api-c:
      ### 当客户端发送请求 127.0.0.1:80/api-pay开头的 都会转发到支付服务
      path: /api-pay/**
      ##订单服务别名
      serviceId: app-itmayiedu-pay
###默认服务读取eureka注册服务列表 默认间隔30秒

```

网关拦截类

``` java
@Component
public class TokenFilter extends ZuulFilter {
	@Value("${server.port}")
	private String port;
	// 编写过滤器拦截业务逻辑代码
	public Object run() throws ZuulException {
		// 案例：拦截所有的服务接口，判断服务接口上是否有传递userToken参数

		// 1.获取上下文
		RequestContext currentContext = RequestContext.getCurrentContext();
		// 2.获取 Request
		HttpServletRequest request = currentContext.getRequest();
		// 3.获取token 的时候 从请求头中获取
		String userToken = request.getParameter("token");
		if (StringUtils.isEmpty(userToken)) {
			// 不会继续执行... 不会去调用服务接口，网关服务直接响应给客户端
			currentContext.setSendZuulResponse(false);
			currentContext.setResponseBody("userToken is null");
			currentContext.setResponseStatusCode(401);
			return null;
			// 返回一个错误提示
		}
		// 正常执行调用其他服务接口...
		System.out.println("网关的接口:"+port);
		return null;
	}

	public boolean shouldFilter() {

		return true;
	}

	// 过滤器执行顺序,当一个请求在同一个阶段的时候存在多个过滤器的时候，多个过滤器执行顺序
	public int filterOrder() {
		return 0;
	}

	// 过滤类型 pre 表示在请求之前进行执行
	@Override
	public String filterType() {
		return "pre";
	}
	// 网关过滤器如何编写
}
```

启动类：

``` java
@SpringBootApplication
@EnableEurekaClient
@EnableZuulProxy
public class AppGateWay {
	// @EnableZuulProxy 开启网关代理
	public static void main(String[] args) {
		SpringApplication.run(AppGateWay.class, args);
	}
}
```

启动两个网关，端口分别为  81、82，不会启动的传送门{% post_link springCloud入门 %}。启动后访问  <http://solo.ning.com/api-member/?token=1231>  效果如下：

![1](1.PNG)

启动的两个网关服务，以此打印出端口号如下：

![2](2.PNG)

![3](3.PNG)

前面的 nginx 配置文件是不用加权重就可以进行轮训的，因为谷歌浏览器的原因，换个火狐或者其他的浏览器就可以了！这个问题不大。

